<!DOCTYPE html>
<html lang="en-us">
  <head>
    <link href="http://gmpg.org/xfn/11" rel="profile">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <!-- Enable responsiveness on mobile devices-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title>
      Unity Android * An optimization retrospective &middot; Mick Derks
    </title>
    <!-- CSS -->
    <link rel="stylesheet" href="/public/css/poole.css">
    <link rel="stylesheet" href="/public/css/syntax.css">
    <link rel="stylesheet" href="/public/css/hyde.css">
    <link rel="stylesheet" href="/public/css/custom.css">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface|Roboto">
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/public/favicon.ico">
    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  </head>
  <body>
    <div class="sidebar">
      <div class="container sidebar-sticky">
        <div class="sidebar-about">
          <h1>
            <a href="/">
              <img src="/assets/img/triangulated_face_glasses.png">
            </a>
            <a href="/">
              Mick Derks
            </a>
          </h1>
          <p class="lead">Game Developer, Programmer, Nerd.</p>
        </div>
        <nav class="sidebar-nav">
          <a class="sidebar-nav-item" href="/">Home</a>
          <p>Projects</p>
          <p>Other Pages</p>
          <a class="sidebar-nav-item" href="/projects/flood">Flood</a>
          <a class="sidebar-nav-item" href="/about/">About</a>
        </nav>
      </div>
    </div>
    <div class="content container">
      <div class="post">
        <h1 class="post-title">Unity Android * An optimization retrospective</h1>
        <span class="post-date">02 Apr 2017</span>
        <p>I’ve been working on <a href="projects/flood">Flood</a> for a few weeks now. It’s been fun to finally call something complete and actually be proud of it. It means I can tell people I’m a game developer and not feel like an abysmal failure because I’ve got nothing to show them.</p>
        <p>The project started as something simple but very polished that I can use as a portfolio piece.
          Because of this I consider the game’s performance to be incredibly important. This meant that after the initial prototype was complete I’ve made several performance passes on the game.</p>
        <div class="right-extending">
          <table>
            <thead>
              <tr>
                <th>Parts</th>
                <th>Desktop</th>
                <th>Laptop</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>CPU</td>
                <td>i5-3570k</td>
                <td>i7-4710MQ</td>
              </tr>
              <tr>
                <td>RAM</td>
                <td>16GB</td>
                <td>8GB</td>
              </tr>
              <tr>
                <td>GPU</td>
                <td>R9 380</td>
                <td>GTX 860M</td>
              </tr>
            </tbody>
          </table>
        </div>
        <p>Development was done partially on my desktop and laptop. Both are generally significantly most powerful than even the most high-end phones, not to mention the average phone, so during development I did not have any real performance issues for the most part. However, performance dropped off a cliff when I initially started testing on mobile.</p>
        <table>
          <thead>
            <tr>
              <th>Grid Size</th>
              <th>UGUI</th>
              <th>Individual Quads</th>
              <th>Single Static Mesh</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>24x24</td>
              <td>&lt;5fps</td>
              <td>20-60fps</td>
              <td>60fps</td>
            </tr>
            <tr>
              <td>36x36</td>
              <td>-</td>
              <td>5-10fps</td>
              <td>60fps</td>
            </tr>
          </tbody>
        </table>
        <p>Initially I had capped the grid size at 24x24, but during the initial rounds of testing I got requests to increase this number. Unfortunately, when I first tried to bump it up to 36x36 it just ground to a halt. This was my cue to invest some serious time and effort into getting used to Unity’s profiling tools.</p>
        <h3 id="unity-ui-grid-the-naive-approach">Unity UI Grid; the naive approach.</h3>
        <p>A quick note on my initial prototyping approach. It was all done in UGUI. Now, I knew this wasn’t a great solution, but it worked.</p>
        <p>On a 24x24 grid that meant 576 tiles. Each tile had a sprite for color (and possible texture), and a sprite for the overlayed icon. Every child was tweened separately using the truly wonderful <a href="http://dotween.demigiant.com/">DOTween</a>. I didn’t actually profile this approach thoroughly before I scrapped and rewrote it, but just rendering alone ran into performance issues on my desktop. After watching <a href="https://www.youtube.com/watch?v=n*oZa4Fb12U">this Unite 2016 presentation by Ian Dundore</a> I realised just how poorly optimized this approach was.</p>
        <ul>
          <li>Everything was done in UGUI, and all in the same canvas.</li>
        </ul>
        <p>I didn’t know exactly how big of a deal this was until I watched that presentation. But after that I realised that every time I changed those transforms it would rebuild the entire canvas. That meant every UI element, but more importantly that meant that on a 24x24 grid all 576 tiles would also be rebuilt. I thought, when writing it, that changing a recttransform’s scale was not included in this. I was wrong. My entire canvas was rebuilt every single frame anything happened at all.</p>
        <ul>
          <li>Render order problems were ‘handled’ by setting sibling index to last.</li>
        </ul>
        <p>Due to the way Unity renders its UGUI system in the order in which its transforms are laid out, every scaling tile would be drawn over by any tile after it. To fix this, instead of messing with the render order for each <code>CanvasRenderer</code> component, I hacked it together by reordering all animating tiles to be the last children of their parent. Unfortunately this caused a lot of memory being shuffled around every time I did this. I didn’t do it every frame, only</p>
        <h3 id="individual-quads-the-batching-nightmare">Individual Quads; the batching nightmare.</h3>
        <h3 id="garbage-collection">Garbage Collection!</h3>
        <h3 id="single-mesh-the-solution">Single mesh; the solution.</h3>
      </div>
      <div class="related">
        <h2>Related Posts</h2>
        <ul class="related-posts">
          <li>
            <h3>
              <a href="/test/2017/04/01/test-page-1/">
                What's this?
                <small>01 Apr 2017</small>
              </a>
            </h3>
          </li>
          <li>
            <h3>
              <a href="/jekyll/update/2017/03/31/welcome-to-jekyll/">
                Welcome to Jekyll!
                <small>31 Mar 2017</small>
              </a>
            </h3>
          </li>
        </ul>
      </div>
    </div>
  </body>
</html>